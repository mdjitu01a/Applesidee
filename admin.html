<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycby2I6lCDZy8dZNDEYtu_tqY8lod4dXwzU5v6tp4Dj_if5F22n7FcEz7XoSj6uUWDcnA/exec';

    const ADMIN_PASSWORD = "123456"; // চেঞ্জ করুন নিরাপত্তার জন্য

    function checkAdmin() {
        if (document.getElementById('adminPass').value === ADMIN_PASSWORD) {
            document.getElementById('adminLoginModal').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            loadProducts();
            loadOrders(); // নতুন: অর্ডার লোড করুন
        } else {
            alert("ভুল পাসওয়ার্ড!");
        }
    }

    async function loadProducts() {
        try {
            const response = await fetch(API_URL + '?action=getProducts'); // অ্যাকশন যোগ করুন যদি দরকার
            const data = await response.json();
            renderProducts(data);
        } catch (err) {
            console.error('প্রোডাক্ট লোড হয়নি:', err);
        }
    }

    function renderProducts(products) {
        const list = document.getElementById('adminProductList');
        list.innerHTML = '';
        products.forEach(p => {
            const item = document.createElement('div');
            item.className = 'product-item';
            item.innerHTML = `
                <h3>${p.name}</h3>
                <p>দাম: ৳${p.price} ${p.old ? `(আগের: ৳${p.old})` : ''}</p>
                <p>ক্যাটাগরি: ${p.category}</p>
                <p>স্টক: ${p.stock || 'N/A'}</p>
                <img src="${p.img}" style="max-width:100%; border-radius:8px; height:180px; object-fit:contain;">
                <div class="actions">
                    <button onclick="deleteProduct('${p.id}')" class="btn btn-danger">ডিলিট</button>
                </div>
            `;
            list.appendChild(item);
        });
    }

    async function deleteProduct(id) {
        if (confirm('প্রোডাক্ট ডিলিট করবেন?')) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'deleteProduct', id })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('ডিলিট হয়েছে!');
                    loadProducts();
                }
            } catch (err) {
                alert('সমস্যা: ' + err.message);
            }
        }
    }

    document.getElementById('productForm').addEventListener('submit', e => {
        e.preventDefault();
        const fileInput = document.getElementById('imageFile');
        const file = fileInput.files[0];
        if (!file) {
            alert("অনুগ্রহ করে একটি ছবি সিলেক্ট করুন");
            return;
        }
        const reader = new FileReader();
        reader.onload = async function(ev) {
            const newProduct = {
                action: "addProduct",
                id: Date.now().toString(),
                name: document.getElementById('name').value.trim(),
                price: parseInt(document.getElementById('price').value) || 0,
                old: parseInt(document.getElementById('oldPrice').value) || null,
                img: ev.target.result,
                category: document.getElementById('category').value.trim().toLowerCase(),
                stock: parseInt(document.getElementById('stock').value) || 0
            };
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(newProduct)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert("প্রোডাক্ট যোগ হয়েছে!");
                    e.target.reset();
                    document.getElementById('preview').innerHTML = '';
                    loadProducts();
                } else {
                    alert("সমস্যা হয়েছে: " + result.message);
                }
            } catch (err) {
                alert("ইন্টারনেট চেক করো: " + err.message);
            }
        };
        reader.readAsDataURL(file);
    });

    document.getElementById('imageFile').addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = ev => {
                document.getElementById('preview').innerHTML = `
                    <img src="${ev.target.result}" style="max-width:220px; max-height:220px; object-fit:contain; margin-top:10px; border-radius:8px;">
                `;
            };
            reader.readAsDataURL(file);
        }
    });

    // নতুন: অর্ডার লোড করুন API থেকে
    async function loadOrders() {
        try {
            const response = await fetch(API_URL + '?action=getOrders'); // আপনার Apps Script এ getOrders হ্যান্ডেল করুন
            const data = await response.json();
            renderOrders(data);
        } catch (err) {
            console.error('অর্ডার লোড হয়নি:', err);
            document.getElementById('orderTableBody').innerHTML = '<tr><td colspan="14">অর্ডার লোড হয়নি।</td></tr>';
        }
    }

    // নতুন: অর্ডার রেন্ডার করুন
    function renderOrders(orders) {
        const tableBody = document.getElementById('orderTableBody');
        tableBody.innerHTML = '';
        if (orders.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="14">কোনো অর্ডার নেই।</td></tr>';
            return;
        }
        orders.forEach(order => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${order.id}</td>
                <td>${order.productName}</td>
                <td>${order.quantity}</td>
                <td>৳${order.totalPrice}</td>
                <td>${order.customerName}</td>
                <td>${order.phone}</td>
                <td>${order.address}</td>
                <td>${order.paymentType}</td>
                <td>${order.paymentMethod || 'N/A'}</td>
                <td>${order.trxId || 'N/A'}</td>
                <td>${order.screenshot ? '<img src="' + order.screenshot + '" width="50">' : 'N/A'}</td>
                <td>${new Date(order.timestamp).toLocaleString('bn-BD')}</td>
                <td class="status-${order.status.toLowerCase()}">${order.status}</td>
                <td>
                    <button onclick="updateOrderStatus('${order.id}', 'processing')" class="btn btn-primary">প্রসেসিং</button>
                    <button onclick="updateOrderStatus('${order.id}', 'approved')" class="btn btn-success">অ্যাপ্রুভ</button>
                    <button onclick="updateOrderStatus('${order.id}', 'delivered')" class="btn btn-success">ডেলিভার্ড</button>
                    <button onclick="updateOrderStatus('${order.id}', 'cancelled')" class="btn btn-danger">ক্যানসেল</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // নতুন: অর্ডার স্ট্যাটাস আপডেট
    async function updateOrderStatus(id, newStatus) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateOrder', id, status: newStatus })
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('স্ট্যাটাস আপডেট হয়েছে!');
                loadOrders();
            }
        } catch (err) {
            alert('সমস্যা: ' + err.message);
        }
    }

    // এক্সপোর্ট/ইমপোর্ট (পুরোনো)
    function exportProducts() {
        // ... (আপনার পুরোনো কোড)
    }

    function importProducts() {
        // ... (আপনার পুরোনো কোড)
    }

    // লগইন হলে লোড
    if (document.getElementById('adminContent').style.display !== 'none') {
        loadProducts();
        loadOrders();
    }
</script>
