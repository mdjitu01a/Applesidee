<!-- admin.html -->
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwK2QXSp1i-s8cD5hEVp_0ONKzCbSyZxr2NEzobJlHdzlmxDN97a32sh1ADJgyqa-kW/exec';
const ADMIN_PASSWORD = "123456";

let products = [];
let orders = [];

function checkAdmin() {
    if(document.getElementById('adminPass').value===ADMIN_PASSWORD){
        document.getElementById('adminLoginModal').style.display='none';
        document.getElementById('adminContent').style.display='block';
        loadProducts();
        loadOrders();
    }else alert("ভুল পাসওয়ার্ড!");
}

// প্রোডাক্ট লোড
async function loadProducts(){
    try{
        const res = await fetch(API_URL+'?action=getProducts');
        products = await res.json();
        renderProducts();
    }catch(err){
        console.error(err);
        document.getElementById('adminProductList').innerHTML='<p style="color:red;text-align:center;">প্রোডাক্ট লোড হয়নি।</p>';
    }
}

// প্রোডাক্ট রেন্ডার
function renderProducts(){
    const grid = document.getElementById('adminProductList');
    grid.innerHTML='';
    if(products.length===0){grid.innerHTML='<p style="text-align:center;color:#777;">কোনো প্রোডাক্ট নেই</p>';return;}
    products.forEach(p=>{
        const card=document.createElement('div');
        card.className='product-card';
        card.innerHTML=`
        <img src="${p.img}" class="product-img">
        <div class="product-info">
            <div class="product-title">${p.name}</div>
            <div class="product-price">৳${p.price} ${p.old?`<small>(আগের ৳${p.old})</small>`:''}</div>
            <div>ক্যাটাগরি: ${p.category}</div>
            <div>স্টক: ${p.stock || 'N/A'}</div>
        </div>
        <div class="actions">
            <button onclick="deleteProduct('${p.id}')" class="btn-danger" style="width:100%;margin-top:10px;">ডিলিট</button>
        </div>`;
        grid.appendChild(card);
    });
}

// প্রোডাক্ট ডিলিট
async function deleteProduct(id){
    if(confirm('প্রোডাক্ট ডিলিট করবেন?')){
        await fetch(API_URL, {
            method:'POST',
            body: JSON.stringify({action:'deleteProduct',id})
        });
        loadProducts();
    }
}

// অর্ডার লোড
async function loadOrders(){
    try{
        const res = await fetch(API_URL+'?action=getOrders');
        orders = await res.json();
        renderOrders();
    }catch(err){ console.error(err); }
}

function renderOrders(){
    const tbody = document.getElementById('orderTableBody');
    tbody.innerHTML='';
    orders.forEach(o=>{
        const row=document.createElement('tr');
        row.innerHTML=`
        <td>${o.id}</td>
        <td>${o.product}</td>
        <td>${o.quantity}</td>
        <td>৳${o.total}</td>
        <td>${o.customerName}</td>
        <td>${o.phone}</td>
        <td>${o.address}</td>
        <td>${o.paymentType}</td>
        <td>${o.paymentMethod || 'N/A'}</td>
        <td>${o.trxId || 'N/A'}</td>
        <td>${o.screenshot || 'N/A'}</td>
        <td>${o.time}</td>
        <td><span class="status-badge status-${o.status.toLowerCase()}">${o.status}</span></td>
        <td>
            <select onchange="updateOrderStatus('${o.id}',this.value)">
                <option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option>
                <option value="Confirmed" ${o.status==='Confirmed'?'selected':''}>Confirmed</option>
                <option value="Processing" ${o.status==='Processing'?'selected':''}>Processing</option>
                <option value="Delivered" ${o.status==='Delivered'?'selected':''}>Delivered</option>
                <option value="Cancelled" ${o.status==='Cancelled'?'selected':''}>Cancelled</option>
            </select>
        </td>`;
        tbody.appendChild(row);
    });
}

// অর্ডার স্ট্যাটাস আপডেট
async function updateOrderStatus(id,status){
    await fetch(API_URL,{
        method:'POST',
        body: JSON.stringify({action:'updateOrderStatus',id,status})
    });
    loadOrders();
}

// প্রোডাক্ট অ্যাড (ইমেজ প্রিভিউসহ)
document.getElementById('imageFile').addEventListener('change', e=>{
    const file=e.target.files[0];
    if(file){
        const reader=new FileReader();
        reader.onload=function(evt){
            document.getElementById('preview').innerHTML=`<img src="${evt.target.result}" class="preview-img">`;
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('productForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const name=document.getElementById('name').value;
    const price=document.getElementById('price').value;
    const oldPrice=document.getElementById('oldPrice').value;
    const img=document.querySelector('#imageFile').files[0];
    const category=document.getElementById('category').value;
    const stock=document.getElementById('stock').value;

    // ইমেজ Upload as Base64
    const reader=new FileReader();
    reader.onload=async function(evt){
        await fetch(API_URL,{
            method:'POST',
            body: JSON.stringify({
                action:'addProduct',
                name,price,oldPrice,img:evt.target.result,category,stock
            })
        });
        loadProducts();
        document.getElementById('productForm').reset();
        document.getElementById('preview').innerHTML='';
    };
    reader.readAsDataURL(img);
});
</script>
