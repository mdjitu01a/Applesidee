<!-- customer.html -->
<script>
const API_URL='https://script.google.com/macros/s/AKfycbwK2QXSp1i-s8cD5hEVp_0ONKzCbSyZxr2NEzobJlHdzlmxDN97a32sh1ADJgyqa-kW/exec';
let products=[],orders=JSON.parse(localStorage.getItem('orders'))||[];
let currentUserPhone = localStorage.getItem('customerPhone')||null;

function saveOrders(){localStorage.setItem('orders',JSON.stringify(orders));}

async function loadProducts(){
    try{
        const res=await fetch(API_URL+'?action=getProducts');
        products=await res.json();
        renderProducts(products);
    }catch(err){ console.error(err); document.getElementById('productGrid').innerHTML='<p style="text-align:center;color:red;">প্রোডাক্ট লোড হয়নি।</p>'; }
}

function renderProducts(filtered=products){
    const grid=document.getElementById('productGrid');
    grid.innerHTML='';
    if(filtered.length===0){grid.innerHTML='<p style="text-align:center;">কোনো প্রোডাক্ট নেই</p>'; return;}
    filtered.forEach(p=>{
        const card=document.createElement('div');
        card.className='product-card';
        card.innerHTML=`
        <img src="${p.img}" class="product-img">
        <div class="product-info">
            <div class="product-title">${p.name}</div>
            <div class="price">৳${p.price} ${p.old?`<span class="old-price">৳${p.old}</span>`:''}</div>
            <button class="buy-btn" onclick="openOrderForm('${p.name.replace(/'/g,"\\'")}',${p.price})"><i class="fab fa-whatsapp"></i> কিনুন</button>
        </div>`;
        grid.appendChild(card);
    });
}

function openOrderForm(name,price){
    document.getElementById('orderProductName').value=name;
    document.getElementById('orderProductPrice').value=price;
    const qty=document.getElementById('quantity');
    const total=document.getElementById('totalAmountDisplay');
    function updateTotal(){ total.textContent=price*qty.value; }
    updateTotal();
    qty.addEventListener('input',updateTotal);
    document.getElementById('orderFormModal').style.display='flex';
}

// অর্ডার সাবমিট
document.getElementById('orderDetailsForm').addEventListener('submit',async e=>{
    e.preventDefault();
    const name=document.getElementById('fullName').value.trim();
    const phone=document.getElementById('phone').value.trim();
    const address=document.getElementById('address').value.trim();
    const email=document.getElementById('email').value.trim();
    const size=document.getElementById('size').value.trim();
    const qty=document.getElementById('quantity').value;
    const productName=document.getElementById('orderProductName').value;
    const productPrice=document.getElementById('orderProductPrice').value;
    const paymentType=document.querySelector('input[name="paymentType"]:checked').value;
    let paymentMethod='',trxId='',screenshot='';

    if(!name||!phone||!address||!qty){ alert('সকল প্রয়োজনীয় তথ্য দিন'); return;}

    if(paymentType==='advance'){
        paymentMethod=document.getElementById('paymentMethod').value;
        trxId=document.getElementById('trxId').value.trim();
        const file=document.getElementById('paymentScreenshot').files[0];
        screenshot=file?file.name:'নেই';
        if(!paymentMethod||!trxId){ alert('Payment Method ও TrxID দিন!'); return;}
    }

    const order={
        action:'addOrder',
        id:Date.now().toString(),
        customerName:name,phone,address,email:email||'নেই',size:size||'N/A',
        product:productName,quantity:qty,price:productPrice,total:productPrice*qty,
        time:new Date().toLocaleString('bn-BD'),paymentType,paymentMethod,trxId,screenshot,status:'Pending'
    };

    try{
        const res=await fetch(API_URL,{method:'POST',body:JSON.stringify(order)});
        const result=await res.json();
        if(result.status==='success'){
            orders.push(order);
            saveOrders();
            const msg=`নতুন অর্ডার!\nপ্রোডাক্ট: ${productName}\nটোটাল: ৳${productPrice*qty}\nপেমেন্ট: ${paymentType==='cod'?'COD':'Advance ('+paymentMethod+')\nTrxID:'+trxId+'\nScreenshot:'+screenshot}\nনাম: ${name}\nফোন: ${phone}\nঠিকানা: ${address}`;
            window.open(`https://wa.me/8801713574848?text=${encodeURIComponent(msg)}`,'_blank');
            alert('অর্ডার সফলভাবে পাঠানো হয়েছে!');
            document.getElementById('orderFormModal').style.display='none';
            e.target.reset();
            document.getElementById('advancePaymentSection').style.display='none';
        }else alert(result.message||'সমস্যা হয়েছে');
    }catch(err){ alert('ইন্টারনেট চেক করুন: '+err.message); }
});

// পেমেন্ট টাইপ অনুযায়ী শো/হাইড
document.querySelectorAll('input[name="paymentType"]').forEach(r=>{
    r.addEventListener('change',()=>{ document.getElementById('advancePaymentSection').style.display=r.value==='advance'?'block':'none'; });
});

// সার্চ
document.getElementById('searchInput').addEventListener('input',e=>{
    const term=e.target.value.toLowerCase();
    renderProducts(products.filter(p=>p.name.toLowerCase().includes(term)));
});

// ক্যাটাগরি ফিল্টার
document.querySelectorAll('.cat-item').forEach(item=>{
    item.addEventListener('click',()=>{
        document.querySelectorAll('.cat-item').forEach(i=>i.classList.remove('active'));
        item.classList.add('active');
        const cat=item.dataset.category;
        renderProducts(cat==='all'?products:products.filter(p=>p.category===cat));
    });
});

loadProducts();
</script>
